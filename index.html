<!DOCTYPE html>

<html lang="zh">

<head>

    <meta charset="UTF-8">

    <title>è®¤çŸ¥çµæ´»æ€§å®éªŒ</title>

    <!-- æ·»åŠ Excelå¯¼å‡ºç›¸å…³åº“ -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>

        /* åŸºç¡€æ ·å¼ */

        body {

            font-family: Arial, sans-serif;

            max-width: 1000px;

            margin: 0 auto;

            padding: 5px;

            background-color: #f5f5f5;

        }

        

        /* å®éªŒç•Œé¢å¸ƒå±€ */

        .screen {

            display: none;

            background-color: white;

            padding: 10px;

            border-radius: 10px;

            box-shadow: 0 2px 5px rgba(0,0,0,0.1);

        }

        

        .active {

            display: block;

        }

        

        /* å›¾ç‰‡å®¹å™¨æ ·å¼ */

        .image-container {

            display: flex;

            flex-direction: column;

            gap: 25px;

            margin: 12px 0;

            align-items: center;

            background-color: #333;

            padding: 8px;

            border-radius: 8px;

            max-width: 500px;

            margin-left: auto;

            margin-right: auto;

        }

        

        /* å®éªŒå›¾ç‰‡æ ·å¼ */

        .exp-image {

            width: 425px;

            height: 85px;

            cursor: pointer;

            border: 3px solid #ddd;

            transition: all 0.3s;

            border-radius: 6px;

            background-color: white;

        }

        

        /* ä¿®æ”¹å›¾ç‰‡åˆ†å‰²çº¿æ ·å¼ï¼Œä½¿å…¶æ›´åŠ æ˜æ˜¾ */

        .image-divider {

            width: 565px;

            height: 2px;

            background-color: #888;

            margin: 8px 0;

        }

        

        /* ä¿®æ”¹å›¾ç‰‡åŒ…è£…å™¨æ ·å¼ï¼Œæ·»åŠ æ›´æ˜æ˜¾çš„è¾¹æ¡†å’ŒèƒŒæ™¯è‰²å¯¹æ¯” */

        .image-wrapper {

            display: flex;

            flex-direction: column;

            align-items: center;

            width: 95%;

            margin-bottom: 8px;

            padding: 5px;

            border: 2px solid #555;

            border-radius: 6px;

            background-color: #333;

            box-shadow: 0 1px 3px rgba(0,0,0,0.2);

        }

        

        /* è°ƒæ•´å›¾ç‰‡åºå·æ ·å¼ï¼Œä½¿å…¶æ›´åŠ é†’ç›® */

        .image-number {

            font-size: 14px;

            font-weight: bold;

            color: #000;

            margin-bottom: 8px;

            background-color: #e0e0e0;

            padding: 2px 6px;

            border-radius: 4px;

            align-self: flex-start;

            margin-left: 2px;

        }

        

        /* å¼ºåŒ–é€‰ä¸­çŠ¶æ€ */

        .selected {

            border-color: #4CAF50;

            box-shadow: 0 0 8px rgba(76, 175, 80, 0.7);

            transform: scale(1.02);

        }

        

        /* æŒ‰é’®æ ·å¼ */

        .btn {

            padding: 8px 15px;

            font-size: 14px;

            background-color: #4CAF50;

            color: white;

            border: none;

            border-radius: 5px;

            cursor: pointer;

            margin: 8px 0;

            transition: background-color 0.3s;

        }

        

        .btn:hover {

            background-color: #45a049;

        }

        

        .btn:disabled {

            background-color: #cccccc;

            cursor: not-allowed;

        }

        

        /* è¿›åº¦æ˜¾ç¤ºæ ·å¼ */

        .progress {

            margin: 5px 0;

            font-size: 14px;

            text-align: center;

            background-color: #f8f9fa;

            padding: 5px;

            border-radius: 4px;

        }

        

        /* è¡¨å•æ ·å¼ */

        .form-group {

            margin: 15px auto;

            max-width: 400px;

        }

        

        .form-group label {

            display: block;

            margin-bottom: 5px;

            font-weight: bold;

            text-align: left;

        }

        

        .form-group input, 

        .form-group select {

            padding: 10px;

            font-size: 16px;

            width: 100%;

            border: 1px solid #bbb;

            border-radius: 4px;

            background-color: #f8f8f8;

            transition: border-color 0.3s, box-shadow 0.3s;

        }

        

        .form-group input:focus, 

        .form-group select:focus {

            border-color: #4CAF50;

            outline: none;

            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);

        }

        

        #info-form .btn {

            margin-top: 25px;

            min-width: 150px;

        }

        

        /* é”™è¯¯æç¤ºæ ·å¼ */

        .error {

            color: #ff0000;

            margin: 5px 0;

            font-size: 14px;

        }



        .button-group {

            display: flex;

            gap: 10px;

            justify-content: center;

            margin-top: 15px;

        }

        

        .button-group .btn {

            min-width: 120px;

        }

        

        /* ç»“æœæ˜¾ç¤ºåŒºåŸŸæ ·å¼ */

        #results-display {

            margin-top: 20px;

            background-color: #fff;

            padding: 15px;

            border-radius: 5px;

            max-height: 400px;

            overflow-y: auto;

        }



        .results-table {

            width: 100%;

            border-collapse: collapse;

            margin-bottom: 15px;

        }

        

        .results-table td, .results-table th {

            border: 1px solid #ddd;

            padding: 8px;

            text-align: left;

        }

        

        .results-table th {

            background-color: #f5f5f5;

        }



        #instruction {

            margin: 5px 0;

            font-size: 14px;

            color: #333;

            line-height: 1.3;

        }



        /* é˜²æ­¢å›¾ç‰‡æ“ä½œæ ·å¼ */

        .exp-image {

            -webkit-user-select: none;

            -moz-user-select: none;

            -ms-user-select: none;

            user-select: none;

            -webkit-user-drag: none;

            -webkit-touch-callout: none;

            pointer-events: auto;

        }



        /* åŠ è½½æç¤ºæ ·å¼ */

        .loading-screen {

            position: fixed;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(255, 255, 255, 0.9);

            display: flex;

            flex-direction: column;

            justify-content: center;

            align-items: center;

            z-index: 1000;

        }



        .loading-progress {

            width: 300px;

            height: 20px;

            background: #f0f0f0;

            border-radius: 10px;

            overflow: hidden;

            margin: 10px 0;

        }



        .loading-bar {

            height: 100%;

            background: #4CAF50;

            width: 0%;

            transition: width 0.3s ease;

        }



        .loading-text {

            font-size: 16px;

            color: #333;

            margin-top: 10px;

        }



        /* ç¾åŒ–ä¿¡æ¯è¾“å…¥ç•Œé¢ */

        #info-screen {

            text-align: center;

        }



        #info-screen h2 {

            margin-bottom: 25px;

            color: #2e7d32;

        }



        /* ç¾åŒ–å®éªŒä»‹ç»ç•Œé¢ */

        .intro-container {

            max-width: 700px;

            margin: 0 auto;

            padding: 20px;

            background-color: white;

            border-radius: 10px;

            box-shadow: 0 3px 10px rgba(0,0,0,0.1);

        }



        .intro-container h2 {

            color: #2e7d32;

            text-align: center;

            margin-bottom: 25px;

            font-size: 28px;

            border-bottom: 2px solid #e0e0e0;

            padding-bottom: 15px;

        }



        .intro-content {

            padding: 10px 20px;

        }



        .welcome-text {

            font-size: 20px;

            color: #333;

            text-align: center;

            font-weight: bold;

            margin-bottom: 20px;

        }



        .intro-description {

            background-color: #f8f9fa;

            padding: 20px;

            border-radius: 8px;

            margin-bottom: 20px;

            border-left: 4px solid #4CAF50;

        }



        .intro-description p {

            margin-top: 0;

            font-weight: bold;

            color: #333;

        }



        .intro-description ul {

            padding-left: 15px;

        }



        .intro-description li {

            margin-bottom: 12px;

            line-height: 1.5;

            list-style-type: none;

            position: relative;

            padding-left: 30px;

        }



        .intro-icon {

            position: absolute;

            left: 0;

            font-style: normal;

            font-size: 18px;

        }



        .intro-footer {

            text-align: center;

            margin-top: 30px;

        }



        .intro-footer p {

            margin-bottom: 15px;

            font-style: italic;

            color: #555;

        }



        .intro-btn {

            min-width: 150px;

            font-size: 16px;

            padding: 10px 20px;

            background-color: #2e7d32;

            transition: all 0.3s ease;

        }



        .intro-btn:hover {

            background-color: #1b5e20;

            transform: translateY(-2px);

            box-shadow: 0 4px 8px rgba(0,0,0,0.2);

        }

    </style>

</head>

<body>

    <div id="loading-screen" class="loading-screen" style="display: none;">

        <h2>èµ„æºåŠ è½½ä¸­...</h2>

        <div class="loading-progress">

            <div id="loading-bar" class="loading-bar"></div>

        </div>

        <div id="loading-text" class="loading-text">0%</div>

    </div>



    <!-- ä¿¡æ¯è¾“å…¥ç•Œé¢ -->

    <div id="info-screen" class="screen active">

        <h2>å‚ä¸è€…ä¿¡æ¯</h2>

        <form id="info-form">

            <div class="form-group">

                <label for="name">å§“åï¼š</label>

                <input type="text" id="name" required>

            </div>

            <div class="form-group">

                <label for="birthday">å‡ºç”Ÿå¹´æœˆï¼š</label>

                <input type="date" id="birthday" required>

            </div>

            <div class="form-group">

                <label for="gender">æ€§åˆ«ï¼š</label>

                <select id="gender" required>

                    <option value="">è¯·é€‰æ‹©</option>

                    <option value="male">ç”·</option>

                    <option value="female">å¥³</option>

                </select>

            </div>

            <div class="form-group">

                <label for="class">ç­çº§ï¼š</label>

                <input type="text" id="class" required>

            </div>

            <div class="form-group">

                <label for="kindergarten">å¹¼å„¿å›­ï¼š</label>

                <input type="text" id="kindergarten" required>

            </div>

            <button type="submit" class="btn">å¼€å§‹å®éªŒ</button>

        </form>

    </div>



    <!-- å®éªŒä»‹ç»ç•Œé¢ -->

    <div id="intro-screen" class="screen">

        <div class="intro-container">

            <h2>å®éªŒä»‹ç»</h2>

            <div class="intro-content">

                <p class="welcome-text">æ¬¢è¿å‚åŠ è®¤çŸ¥çµæ´»æ€§å®éªŒ</p>

                <div class="intro-description">

                    <p>åœ¨æœ¬å®éªŒä¸­ï¼Œæ‚¨å°†å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š</p>

                    <ul>

                        <li><i class="intro-icon">ğŸ–¼ï¸</i> è§‚å¯Ÿä¸€ç³»åˆ—å›¾ç‰‡ï¼Œå¹¶é€šè¿‡ç‚¹å‡»æ¥ç»„åˆå®ƒä»¬</li>

                        <li><i class="intro-icon">ğŸ”</i> å¯»æ‰¾ä¸¤å¼ åœ¨æŸäº›æ–¹é¢ç›¸ä¼¼çš„å¡ç‰‡ï¼ˆå¦‚é¢œè‰²ã€å¤§å°ã€å›¾å½¢æˆ–æ•°é‡ï¼‰</li>

                        <li><i class="intro-icon">ğŸ‘†</i> ä»”ç»†è§‚å¯Ÿå¹¶ç‚¹å‡»æ‚¨è®¤ä¸ºç›¸å…³çš„å›¾ç‰‡å¯¹</li>

                        <li><i class="intro-icon">ğŸ”„</i> å®Œæˆæ¼”ç¤ºå’Œç»ƒä¹ ç¯èŠ‚ï¼Œç„¶åè¿›å…¥æ­£å¼å®éªŒ</li>

                    </ul>

                </div>

            </div>

            <div class="intro-footer">

                <p>å‡†å¤‡å¥½åï¼Œè¯·ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®å¼€å§‹</p>

                <button class="btn intro-btn" onclick="startDemo()">å¼€å§‹æ¼”ç¤º</button>

            </div>

        </div>

    </div>



    <!-- æ¼”ç¤ºç¡®è®¤ç•Œé¢ -->

    <div id="show-confirm-screen" class="screen">

        <h2>æ¼”ç¤ºé˜¶æ®µå®Œæˆ</h2>

        <p>æ‚¨æ˜¯å¦å·²ç»å®Œå…¨ç†è§£äº†å®éªŒè§„åˆ™ï¼Ÿ</p>

        <div class="button-group">

            <button class="btn" onclick="returnToDemo()">å›åˆ°æ¼”ç¤º</button>

            <button class="btn" onclick="startPractice()">å¼€å§‹ç»ƒä¹ </button>

        </div>

    </div>



    <!-- ç»ƒä¹ ç¡®è®¤ç•Œé¢ -->

    <div id="test-confirm-screen" class="screen">

        <h2>ç»ƒä¹ é˜¶æ®µå®Œæˆ</h2>

        <p>æ‚¨æ˜¯å¦å·²ç»å®Œå…¨æŒæ¡äº†å®éªŒæ“ä½œï¼Ÿ</p>

        <div class="button-group">

            <button class="btn" onclick="returnToDemo()">é‡æ–°æ¼”ç¤º</button>

            <button class="btn" onclick="startFormalTest()">å¼€å§‹æ­£å¼å®éªŒ</button>

        </div>

    </div>



    <!-- å®éªŒç•Œé¢ -->

    <div id="experiment-screen" class="screen">

        <div class="progress">

            <div id="phase-display"></div>

            <div id="combination-count"></div>

        </div>

        <div id="instruction"></div>

        <div id="image-container" class="image-container"></div>

    </div>



    <!-- ç»“æœç•Œé¢ -->

    <div id="results-screen" class="screen">

        <h2>å®éªŒå®Œæˆ</h2>

        <p>æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p>

        <div class="button-group">

            <button class="btn" onclick="experimentManager.exportToExcel()">å¯¼å‡ºExcel</button>

            <button class="btn" onclick="experimentManager.copyResults()">å¤åˆ¶ç»“æœ</button>

            <button class="btn" onclick="experimentManager.displayResults()">æ˜¾ç¤ºç»“æœ</button>

        </div>

        <div id="results-display" style="display: none;"></div>

    </div>



    <script>

        // å®éªŒç®¡ç†å™¨ç±»

        class ExperimentManager {

            constructor() {

                this.participantInfo = null;

                this.trials = [];

                this.currentPhase = '';

                this.currentTrial = 0;

                this.combinationCount = 0;

                this.startTime = null;

                this.selectedImages = [];

                this.totalScore = 0;          // åˆå§‹åŒ–æ€»åˆ†

                this.totalTime = 0;           // åˆå§‹åŒ–æ€»æ—¶é—´

                this.trialStartTime = null;   // æ·»åŠ è¯•æ¬¡å¼€å§‹æ—¶é—´

                this.imageUrls = new Set();

                this.loadedCount = 0;

                this.totalCount = 0;

                this.correctCombinationsUsed = new Set(); // æ·»åŠ è®°å½•å·²ä½¿ç”¨æ­£ç¡®ç»„åˆçš„å±æ€§

            }



            // æ”¶é›†æ‰€æœ‰å›¾ç‰‡URL

            collectImageUrls() {

                phases.forEach(phase => {

                    const imageFolder = phase.name.startsWith('demo') || phase.name.startsWith('norm') ? 'show' : 'test';

                    for (let i = 1; i <= phase.images; i++) {

                        this.imageUrls.add(`image/${imageFolder}/${phase.name}_image_${i}.png`);

                        this.imageUrls.add(`image/${imageFolder}/${phase.name}_image_${i}.jpg`);

                    }

                });

                this.totalCount = this.imageUrls.size;

            }



            // é¢„åŠ è½½å•ä¸ªå›¾ç‰‡

            preloadImage(url) {

                return new Promise((resolve, reject) => {

                    const img = new Image();

                    img.onload = () => {

                        this.loadedCount++;

                        this.updateProgress();

                        resolve(url);

                    };

                    img.onerror = () => {

                        // å¦‚æœPNGåŠ è½½å¤±è´¥ï¼Œå°è¯•JPG

                        if (url.endsWith('.png')) {

                            resolve(url); // ä¸è®¡å…¥å¤±è´¥

                        } else {

                            this.loadedCount++;

                            this.updateProgress();

                            resolve(url);

                        }

                    };

                    img.src = url;

                });

            }



            // æ›´æ–°åŠ è½½è¿›åº¦

            updateProgress() {

                const progress = (this.loadedCount / this.totalCount) * 100;

                const loadingBar = document.getElementById('loading-bar');

                const loadingText = document.getElementById('loading-text');

                

                loadingBar.style.width = `${progress}%`;

                loadingText.textContent = `${Math.round(progress)}%`;

            }



            // å¼€å§‹é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡

            async preloadAllImages() {

                const loadingScreen = document.getElementById('loading-screen');

                loadingScreen.style.display = 'flex';

                

                this.collectImageUrls();

                const loadPromises = Array.from(this.imageUrls).map(url => this.preloadImage(url));

                

                try {

                    await Promise.all(loadPromises);

                    loadingScreen.style.display = 'none';

                    return true;

                } catch (error) {

                    console.error('é¢„åŠ è½½å¤±è´¥:', error);

                    loadingScreen.style.display = 'none';

                    return false;

                }

            }



            async initialize(participantInfo) {

                // å…ˆè¿›è¡Œé¢„åŠ è½½

                await this.preloadAllImages();

                

                // è®¾ç½®å‚ä¸è€…ä¿¡æ¯

                this.participantInfo = participantInfo;

                

                this.startTime = Date.now();

                this.trialStartTime = Date.now();  // åˆå§‹åŒ–è¯•æ¬¡å¼€å§‹æ—¶é—´

                this.currentPhase = 'demo1';

                this.currentTrial = 0;

                this.combinationCount = 0;

                this.trials = [];

                this.selectedImages = [];

                this.totalScore = 0;

                this.totalTime = 0;

                this.updateDisplay();

                this.correctCombinationsUsed = new Set();

            }





        



            recordTrial(imageId, correct) {

                const currentTime = Date.now();

                const trialTime = currentTime - this.trialStartTime;

                

                const trialData = {

                    phase: this.currentPhase,

                    trial: this.currentTrial + 1,

                    combination: this.combinationCount + 1,

                    selected: imageId,

                    correct: correct,

                    reactionTime: trialTime,

                    timestamp: new Date().toISOString()

                };

            

                this.trials.push(trialData);

                this.totalTime += trialTime;

                

                // ä¿®æ”¹è®¡åˆ†è§„åˆ™ï¼šåªæœ‰pracå’Œtesté˜¶æ®µè®¡åˆ†

                if (correct && (this.currentPhase.startsWith('prac') || this.currentPhase.startsWith('test'))) {

                    this.totalScore++;

                }

                

                this.trialStartTime = currentTime;

            }



            exportToExcel() {

                try {

                    const wb = XLSX.utils.book_new();

                    

                    // å‚ä¸è€…ä¿¡æ¯è¡¨

                    const participantData = [{

                        å§“å: this.participantInfo.name,

                        æ€§åˆ«: this.participantInfo.gender === 'male' ? 'ç”·' : 'å¥³',

                        å‡ºç”Ÿå¹´æœˆ: this.participantInfo.birthday,

                        ç­çº§: this.participantInfo.class,

                        å¹¼å„¿å›­: this.participantInfo.kindergarten,

                        å®éªŒæ—¶é—´: new Date().toLocaleString()

                    }];

                    const wsParticipant = XLSX.utils.json_to_sheet(participantData);

                    XLSX.utils.book_append_sheet(wb, wsParticipant, "å‚ä¸è€…ä¿¡æ¯");

            

                    // å®éªŒæ•°æ®è¡¨

                    const trialData = this.trials.map(trial => ({

                        é˜¶æ®µ: trial.phase,

                        è¯•æ¬¡: trial.trial,

                        ç»„åˆæ¬¡åº: trial.combination,

                        é€‰æ‹©ç»„åˆ: trial.selected,

                        æ˜¯å¦æ­£ç¡®: trial.correct ? 'æ­£ç¡®' : 'é”™è¯¯',

                        ååº”æ—¶é—´_æ¯«ç§’: trial.reactionTime

                    }));

                    const wsTrials = XLSX.utils.json_to_sheet(trialData);

                    XLSX.utils.book_append_sheet(wb, wsTrials, "å®éªŒæ•°æ®");

            

                    // æ±‡æ€»æ•°æ®

                    const summaryData = [{

                        æ€»åˆ†: this.totalScore,

                        æ€»æ—¶é—´_æ¯«ç§’: this.totalTime,

                        ç»ƒä¹ å¾—åˆ†: this.trials.filter(t => t.phase.startsWith('prac') && t.correct).length,

                        æµ‹è¯•å¾—åˆ†: this.trials.filter(t => t.phase.startsWith('test') && t.correct).length

                    }];

                    const wsSummary = XLSX.utils.json_to_sheet(summaryData);

                    XLSX.utils.book_append_sheet(wb, wsSummary, "æ±‡æ€»æ•°æ®");

            

                    // ç”Ÿæˆæ–‡ä»¶å

                    const fileName = `è®¤çŸ¥çµæ´»æ€§å®éªŒ_${this.participantInfo.name}_${this.participantInfo.birthday}_${this.participantInfo.kindergarten}.xlsx`;

                    

                    // å°†å·¥ä½œç°¿è½¬æ¢ä¸ºäºŒè¿›åˆ¶æ ¼å¼

                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

                    

                    // åˆ›å»ºBlobå¯¹è±¡ï¼Œä½¿ç”¨æ­£ç¡®çš„MIME type

                    const blob = new Blob([wbout], { 

                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 

                    });

                    

                    // ä½¿ç”¨FileSaverä¿å­˜æ–‡ä»¶

                    saveAs(blob, fileName);

            

                } catch (error) {

                    console.error('Excelå¯¼å‡ºé”™è¯¯:', error);

                    alert('Excelå¯¼å‡ºå¤±è´¥ï¼Œæ­£åœ¨æ˜¾ç¤ºç»“æœ...');

                    this.displayResults();

                }

            }



            



            copyResults() {

                // ç›´æ¥æ˜¾ç¤ºç»“æœï¼Œä¸å†å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿

                this.displayResults();

                alert('è¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶æ˜¾ç¤ºçš„ç»“æœ');

            }



            displayResults() {

                const resultsDisplay = document.getElementById('results-display');

                if (resultsDisplay.style.display === 'none') {

                    const csvContent = this.generateCSV();

                    resultsDisplay.innerHTML = this.formatResultsToHTML(csvContent);

                    resultsDisplay.style.display = 'block';

                } else {

                    resultsDisplay.style.display = 'none';

                }

            }



            generateCSV() {

                let csvRows = [];

        

                // å‚ä¸è€…ä¿¡æ¯

                csvRows.push(['å‚ä¸è€…ä¿¡æ¯']);

                csvRows.push(['å§“å', 'æ€§åˆ«', 'å‡ºç”Ÿå¹´æœˆ', 'ç­çº§', 'å¹¼å„¿å›­', 'å®éªŒæ—¶é—´']);

                csvRows.push([

                    this.participantInfo.name,

                    this.participantInfo.gender === 'male' ? 'ç”·' : 'å¥³',

                    this.participantInfo.birthday,

                    this.participantInfo.class,

                    this.participantInfo.kindergarten,

                    new Date().toLocaleString()

                ]);

                csvRows.push([]);

        

                // å®éªŒæ•°æ®

                csvRows.push(['å®éªŒæ•°æ®']);

                csvRows.push(['é˜¶æ®µ', 'è¯•æ¬¡', 'ç»„åˆæ¬¡åº', 'é€‰æ‹©ç»„åˆ', 'æ˜¯å¦æ­£ç¡®', 'ååº”æ—¶é—´(ms)']);

        

                this.trials.forEach(trial => {

                    csvRows.push([

                        trial.phase,

                        trial.trial,

                        trial.combination,

                        trial.selected,

                        trial.correct ? '1' : '0',

                        trial.reactionTime

                    ]);

                });

                csvRows.push([]);

        

                // ä¿®æ”¹æ­£ç¡®ç‡è®¡ç®—

                const scoredTrials = this.trials.filter(t => 

                    t.phase.startsWith('prac') || t.phase.startsWith('test')

                );

                const correctTrials = scoredTrials.filter(t => t.correct).length;

                const accuracy = scoredTrials.length > 0 ? 

                    (correctTrials / scoredTrials.length * 100).toFixed(2) : 0;



                // æ·»åŠ åˆ†é˜¶æ®µç»Ÿè®¡

                const pracTrials = this.trials.filter(t => t.phase.startsWith('prac'));

                const testTrials = this.trials.filter(t => t.phase.startsWith('test'));



                const pracCorrect = pracTrials.filter(t => t.correct).length;

                const testCorrect = testTrials.filter(t => t.correct).length;



                // æ±‡æ€»æ•°æ®

                csvRows.push(['å®éªŒæ±‡æ€»']);

                csvRows.push(['æ€»åˆ†', this.totalScore]);

                csvRows.push(['æ€»æ—¶é—´(ms)', this.totalTime]);

                csvRows.push(['æ€»ä½“æ­£ç¡®ç‡(%)', accuracy]);

                csvRows.push(['ç»ƒä¹ é˜¶æ®µæ­£ç¡®æ•°', pracCorrect, '/', pracTrials.length]);

                csvRows.push(['æµ‹è¯•é˜¶æ®µæ­£ç¡®æ•°', testCorrect, '/', testTrials.length]);



                return csvRows.map(row => row.join(',')).join('\n');

            }



            formatResultsToHTML(csvContent) {

                const lines = csvContent.split('\n');

                let html = '';

                let currentTable = '';



                lines.forEach(line => {

                    if (line.trim() === '') {

                        if (currentTable) {

                            html += currentTable + '</table><br>';

                            currentTable = '';

                        }

                    } else if (line.endsWith('ä¿¡æ¯') || line.endsWith('æ•°æ®') || line.endsWith('æ±‡æ€»') || line.endsWith('ç»Ÿè®¡')) {

                        if (currentTable) {

                            html += currentTable + '</table><br>';

                        }

                        html += `<h3>${line}</h3>`;

                        currentTable = '<table class="results-table">';

                    } else {

                        const cells = line.split(',');

                        currentTable += '<tr>' + cells.map(cell => `<td>${cell}</td>`).join('') + '</tr>';

                    }

                });



                if (currentTable) {

                    html += currentTable + '</table>';

                }



                return html;

            }



            calculatePhaseStatistics() {

                const stats = {};

                

                this.trials.forEach(trial => {

                    if (!stats[trial.phase]) {

                        stats[trial.phase] = {

                            totalReactionTime: 0,

                            correctCount: 0,

                            totalCount: 0

                        };

                    }

                    

                    stats[trial.phase].totalReactionTime += trial.reactionTime;

                    stats[trial.phase].correctCount += trial.correct ? 1 : 0;

                    stats[trial.phase].totalCount += 1;

                });



                Object.keys(stats).forEach(phase => {

                    const phaseStat = stats[phase];

                    stats[phase] = {

                        avgReactionTime: phaseStat.totalReactionTime / phaseStat.totalCount,

                        accuracy: phaseStat.correctCount / phaseStat.totalCount

                    };

                });



                return stats;

            }



            updateDisplay() {

                document.getElementById('phase-display').textContent = 

                    `${this.currentPhase} - è¯•æ¬¡ ${this.currentTrial + 1}`;

                document.getElementById('combination-count').textContent = 

                    `ç¬¬ ${this.combinationCount + 1}/2 æ¬¡ç»„åˆ`;

                

                this.showInstructions();

                this.updateImageGrid();

            }



            showInstructions() {

                const instruction = document.getElementById('instruction');

                

                // åŸºäºç»„åˆæ¬¡æ•°æ˜¾ç¤ºä¸åŒçš„æŒ‡å¯¼è¯­

                if (this.combinationCount === 0) {

                    // ç¬¬ä¸€æ¬¡é€‰æ‹©çš„æç¤º

                    instruction.innerHTML = 'è¯·é€‰æ‹©ä¸¤å¼ ä½ è®¤ä¸ºåœ¨æŸäº›æ–¹é¢ä¸€æ ·çš„å¡ç‰‡';

                } else {

                    // ç¬¬äºŒæ¬¡é€‰æ‹©çš„æç¤ºï¼Œæ·»åŠ çº¢è‰²å­—ä½“

                    instruction.innerHTML = '<span style="color: red;">è¯·ä½ å†é€‰æ‹©ä¸¤å¼ ï¼Œåœ¨å…¶ä»– æ–¹é¢ä¸€æ ·çš„å¡ç‰‡</span>';

                }

            }



            updateImageGrid() {

                const container = document.getElementById('image-container');

                container.innerHTML = '';

                

                const imageFolder = this.currentPhase.startsWith('demo') || 

                                  this.currentPhase.startsWith('norm') ? 'show' : 'test';

            

                const phase = phases.find(p => p.name === this.currentPhase);

                

                for (let i = 1; i <= phase.images; i++) {

                    // åˆ›å»ºå›¾ç‰‡åŒ…è£…å™¨

                    const wrapper = document.createElement('div');

                    wrapper.className = 'image-wrapper';

                    

                    // æ·»åŠ å›¾ç‰‡åºå·

                    const numberLabel = document.createElement('div');

                    numberLabel.className = 'image-number';

                    numberLabel.textContent = `å›¾ç‰‡ ${i}`;

                    wrapper.appendChild(numberLabel);

                    

                    // åˆ›å»ºå›¾ç‰‡å…ƒç´ 

                    const img = document.createElement('img');

                    const baseImagePath = `image/${imageFolder}/${this.currentPhase}_image_${i}.png`;

                    

                    img.src = baseImagePath;

                    img.className = 'exp-image';

                    img.dataset.index = i;

                    

                    // æ·»åŠ é”™è¯¯å¤„ç†å’Œäº‹ä»¶ç›‘å¬

                    img.onerror = function() {

                        this.src = this.src.replace('.png', '.jpg');

                        this.onerror = function() {

                            console.error(`Failed to load image: ${this.src}`);

                            this.src = 'image/error.png';

                        }

                    };

                    

                    // ä¿®æ”¹äº‹ä»¶ç»‘å®š

                    img.onclick = (e) => {

                        e.preventDefault();

                        this.handleImageClick(e);

                    };

                    

                    img.ondragstart = (e) => {

                        e.preventDefault();

                    };

                    

                    // å°†å›¾ç‰‡æ·»åŠ åˆ°åŒ…è£…å™¨

                    wrapper.appendChild(img);

                    

                    // å°†åŒ…è£…å™¨æ·»åŠ åˆ°å®¹å™¨

                    container.appendChild(wrapper);

                }

            }



            handleImageClick(e) {

                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º

                const img = e.target;

                if (this.selectedImages.includes(img.dataset.index)) return;



                img.classList.add('selected');

                this.selectedImages.push(img.dataset.index);



                if (this.selectedImages.length === 2) {

                    setTimeout(() => {

                        this.processImageCombination();

                    }, 500);

                }

            }



            processImageCombination() {

                const phase = phases.find(p => p.name === this.currentPhase);

                const combination = this.selectedImages.sort().join('&');

                

                // è·å–å½“å‰å¯ç”¨çš„æ­£ç¡®ç»„åˆï¼ˆæ’é™¤å·²ä½¿ç”¨çš„ï¼‰

                const availableCombinations = phase.combinations.filter(

                    combo => !this.correctCombinationsUsed.has(combo)

                );

                

                const isCorrect = availableCombinations.includes(combination);

                

                if (isCorrect) {

                    this.correctCombinationsUsed.add(combination);

                }

                

                this.recordTrial(combination, isCorrect);

                

                document.querySelectorAll('.exp-image').forEach(img => 

                    img.classList.remove('selected'));

                

                this.selectedImages = [];

                this.combinationCount++;

                

                if (this.combinationCount === 2) {

                    this.combinationCount = 0;

                    this.currentTrial++;

                    this.correctCombinationsUsed.clear(); // æ¸…é™¤å·²ä½¿ç”¨ç»„åˆè®°å½•ï¼Œå‡†å¤‡ä¸‹ä¸€ä¸ªè¯•æ¬¡

                    

                    if (this.currentTrial === phase.trials) {

                        this.advancePhase();

                    }

                }

                

                this.updateDisplay();

            }



            advancePhase() {

                const currentPhaseIndex = phases.findIndex(p => p.name === this.currentPhase);

                

                if (this.currentPhase === 'norm2') {

                    showScreen('show-confirm-screen');

                    return;

                } else if (this.currentPhase === 'prac2') {

                    showScreen('test-confirm-screen');

                    return;

                }



                if (currentPhaseIndex < phases.length - 1) {

                    this.currentPhase = phases[currentPhaseIndex + 1].name;

                    this.currentTrial = 0;

                    this.updateDisplay();

                } else {

                    this.totalTime = Date.now() - this.startTime;

                    showScreen('results-screen');

                    // æ·»åŠ ï¼šå®éªŒç»“æŸåè‡ªåŠ¨è§¦å‘å¯¼å‡º

                    setTimeout(() => this.exportToExcel(), 500);

                }

            }

        }



        // åˆå§‹åŒ–å®éªŒç®¡ç†å™¨

        const experimentManager = new ExperimentManager();



        // å®éªŒé˜¶æ®µé…ç½®

        // ä¿®æ”¹å®éªŒé˜¶æ®µé…ç½®

        const phases = [

        { name: 'demo1', images: 4, combinations: ['1&2', '2&3'], trials: 1 },  // ä¿®æ”¹ä¸ºæ•°ç»„æ ¼å¼

        { name: 'norm1', images: 4, combinations: ['1&2', '2&3'], trials: 1 },

        { name: 'norm2', images: 4, combinations: ['1&2', '1&3'], trials: 1 },

        { name: 'prac1', images: 3, combinations: ['1&2', '2&3'], trials: 1 },

        { name: 'prac2', images: 3, combinations: ['1&2', '1&3'], trials: 1 },

        { name: 'test1', images: 3, combinations: ['1&2', '2&3'], trials: 1 },

        { name: 'test2', images: 3, combinations: ['1&2', '1&3'], trials: 1 },

        { name: 'test3', images: 3, combinations: ['1&2', '2&3'], trials: 1 },

        { name: 'test4', images: 3, combinations: ['1&3', '2&3'], trials: 1 },

        { name: 'test5', images: 3, combinations: ['1&3', '2&3'], trials: 1 },

        { name: 'test6', images: 3, combinations: ['1&2', '1&3'], trials: 1 },

        { name: 'test7', images: 3, combinations: ['1&2', '2&3'], trials: 1 },

        { name: 'test8', images: 3, combinations: ['1&2', '1&3'], trials: 1 },

        { name: 'test9', images: 3, combinations: ['1&2', '1&3'], trials: 1 },

        { name: 'test10', images: 3, combinations: ['1&2', '2&3'], trials: 1 },

        { name: 'test11', images: 3, combinations: ['1&3', '2&3'], trials: 1 },

        { name: 'test12', images: 3, combinations: ['1&3', '2&3'], trials: 1 }

        ];



        // è¾…åŠ©å‡½æ•°

        function showScreen(screenId) {

            document.querySelectorAll('.screen').forEach(screen => 

                screen.classList.remove('active'));

            document.getElementById(screenId).classList.add('active');

        }



        function startDemo() {

            experimentManager.currentPhase = 'demo1';

            experimentManager.currentTrial = 0;

            experimentManager.combinationCount = 0;

            showScreen('experiment-screen');

            experimentManager.updateDisplay();

        }



        function startPractice() {

            experimentManager.currentPhase = 'prac1';

            experimentManager.currentTrial = 0;

            experimentManager.combinationCount = 0;

            showScreen('experiment-screen');

            experimentManager.updateDisplay();

        }



        function startFormalTest() {

            experimentManager.currentPhase = 'test1';

            experimentManager.currentTrial = 0;

            experimentManager.combinationCount = 0;

            showScreen('experiment-screen');

            experimentManager.updateDisplay();

        }



        function returnToDemo() {

            experimentManager.trials = experimentManager.trials.filter(trial => 

                !trial.phase.startsWith('prac') && !trial.phase.startsWith('test'));

            experimentManager.currentPhase = 'demo1';

            experimentManager.currentTrial = 0;

            experimentManager.combinationCount = 0;

            experimentManager.totalScore = 0;

            showScreen('experiment-screen');

            experimentManager.updateDisplay();

        }



        // è¡¨å•æäº¤å¤„ç†

        document.getElementById('info-form').addEventListener('submit', async function(e) {

            e.preventDefault();

            const info = {

                name: document.getElementById('name').value,

                birthday: document.getElementById('birthday').value,

                gender: document.getElementById('gender').value,

                class: document.getElementById('class').value,

                kindergarten: document.getElementById('kindergarten').value

            };

            await experimentManager.initialize(info);

            showScreen('intro-screen');

        });



        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨èšç„¦åˆ°å§“åè¾“å…¥æ¡†

        window.onload = function() {

            document.getElementById('name').focus();

        };



        // é˜²æ­¢æ„å¤–å…³é—­é¡µé¢

        window.onbeforeunload = function(e) {

            if (experimentManager.trials.length > 0) {

                e.preventDefault();

                e.returnValue = '';

                return 'å®éªŒå°šæœªå®Œæˆï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';

            }

        };

    </script>

</body>

</html>
